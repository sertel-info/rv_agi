<?php
require_once __DIR__."/WriteConsoleTrait.php";

class Gravacao{
	
	use WriteConsoleTrait;

	private $tabela = "gravacoes";
	private $db;
	private $arquivo;
	private $ligacao;
	private $dir_rec;
	private $pasta;
	private $unique_id;
	private $opcoes='ab';

	public function __construct(){
	}


	public function gerarNomeArquivo(){
		$dir_rec = $this->dir_rec;
		
		if(!in_array(substr($dir_rec, -1, 1), ['/', '\\'])){
			$dir_rec = $dir_rec.'/';
		}

		$linha = $this->ligacao->getLine();
		$pasta = $this->pasta;
		$exten = $this->ligacao->getExten();
		$callerid = $this->ligacao->getCallerId();
		$unique_id = $this->unique_id;
		$data =  DateTime::createFromFormat('H-i-s-d-m-Y', $this->ligacao->getDate())->format('H_i_s_d_m_Y');
	
		$this->arquivo = "$dir_rec".$linha['assinante_id']."/".
													   $linha["id_linha"]."/".
													   "$pasta/$pasta-$callerid-$exten-$unique_id-$data.wav";

		return $this->arquivo;
	}


	public function save(){
		$linha = $this->ligacao->getLine();

		$data = DateTime::createFromFormat('H-i-s-d-m-Y', $this->ligacao->getDate())->format('Y-m-d H:i:s');

		$this->db->execQuery("INSERT INTO ".$this->tabela.
						 " (exten, callerid, arquivo, data, duracao, unique_id, linha, assinante) ".
						 "VALUES (".
						 "'".$this->ligacao->getExten()."',".
						 "'".$this->ligacao->getCallerId()."',".
						 "'".$this->arquivo."',".
						 "'".$data."',".
						 "'".$this->ligacao->getDuracao()."',".
						 "'".$this->unique_id."',".
						 $linha['linha_id'].",".
						 $linha['assinante_id'].")");

		if($this->db->getError()){
			$this->write_console(__FILE__,__LINE__, "ERRO AO ESCREVER GRAVACAO NO BANCO", $this->db->getError());
		}
	}

	public function setDirRec($dir){
		$this->dir_rec = $dir;
	}

	public function setTabela(){
		$this->tabela = $tabela;
	}

	public function setPasta($pasta){
		$this->pasta = $pasta;
	}

	public function getTabela(){
		return $this->tabela;
	}

	public function getOpcoes(){
		return $this->opcoes;
	}

	public function setDb($db){
		$this->db = $db;
	}

	public function getDb(){
		return $this->db;
	}

	public function setUniqueId($unique_id){
		$this->unique_id = $unique_id;
	}

	public function setDirRec($dir_rec){
		$this->dir_rec = $dir_rec;
	}

	public  function getUniqueId(){
		return $this->unique_id;
	}

	public function setArquivo($arquivo){
		$this->arquivo = $arquivo;
	}

	public function getArquivo(){
		return $this->arquivo;
	}

	public function setLigacao($ligacao){
		$this->ligacao = $ligacao;
	}

	public function getLigacao(){
		return $this->ligacao;
	}

}